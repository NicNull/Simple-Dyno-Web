<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>A.R.T. Dyno Test Results</title>
    <style>
        @page { size: A4 landscape; margin: 0.0cm; }
        body { font-family: sans-serif; font-size: 9pt; color: #333; }
        h1 { font-size: 24pt; color: #2c3e50; margin: 0; }
        h2 { font-size: 14pt; color: #333; margin-top: 20px; border-bottom: 1px solid #eee; padding-bottom: 5px;}
        .header-table, .main-table, .footer-table { width: 100%; border-collapse: collapse; }
        .main-table { margin-top: 15px; }
        .header-table td, .main-table td, .footer-table td { vertical-align: top; padding: 5px; }
        .logo { max-width: 80px; }
        .report-title { text-align: right; }
        .report-title p { margin: 4px 0 0 0; font-size: 10pt; color: #666; }
        .meta-info { border-top: 1px solid #e0e0e0; border-bottom: 1px solid #e0e0e0; padding: 8px 0; margin: 15px 0; font-size: 10pt; }
        .chart-img {width: 100%;border: 1px solid #e0e0e0;max-height: 420px;object-fit: contain;}
        .summary-table { width: 100%; border-collapse: collapse; font-size: 8pt; }
        .summary-table th, .summary-table td { border: 1px solid #ddd; padding: 4px 6px; text-align: center; }
        .summary-table th { background-color: #f2f2f2; font-weight: bold; }
        .footer-table { margin-top: 20px; padding-top: 15px; border-top: 1px solid #e0e0e0; }
        .info-card { text-align: center; }
        .info-card h4 { margin: 0 0 4px 0; font-size: 8pt; color: #007bff; font-weight: bold; }
        .info-card p { margin: 0; line-height: 1.2; }
        .info-card .main-value { font-size: 1.2em; font-weight: bold; color: #2c3e50; }
        .info-card .details { font-size: 0.8em; font-weight: normal; color: #666; }
        .info-card .comp-value { font-size: 0.9em; color: #555; }
        .appendix { page-break-before: always; }
        .appendix-table { width: 100%; font-size: 8pt; border-collapse: collapse; }
        .appendix-table th, .appendix-table td { border: 1px solid #ddd; padding: 4px 6px; text-align: center; }
        .appendix-table th { background-color: #f2f2f2; font-weight: bold; }
    </style>
</head>
<body>
    <!-- ======================= PAGE 1: SUMMARY ======================= -->
    <table class="header-table">
        <tr>
            <td><img src="/static/logo.png" class="logo"></td>
            <td class="report-title">
                <h1>A.R.T. Dyno Test Results</h1>
                <p>Main: {{ main_run.filename }}{% if comparison_run %} | Comp: {{ comparison_run.filename }}{% endif %}</p>
            </td>
        </tr>
    </table>

    <div class="meta-info">
        <table style="width: 100%;">
            <tr>
                <td><strong>Customer:</strong> {{ meta.customer_name }}</td>
                <td style="text-align: center;"><strong>Engine:</strong> {{ meta.engine_type }}</td>
                <td style="text-align: right;"><strong>Date:</strong> {{ meta.test_date.split(' ')[0] }}</td>
            </tr>
        </table>
    </div>

    <table class="main-table">
        <tr>
            <td style="width: 65%;">
                <h2>Performance Graph</h2>
                <img src="{{ chart_image }}" alt="Performance Chart" class="chart-img">
            </td>
            <td style="width: 35%;">
                <h2>Summary Data (Main Run)</h2>
                <table class="summary-table">
                    <thead><tr><th>RPM</th><th>Torque (N·m)</th><th>Power (HP)</th></tr></thead>
                    <tbody>
                        {% for row in main_run.aggregated_data %}
                        <tr><td>{{ row.rpm }}</td><td>{{ row.torque }}</td><td>{{ row.hp }}</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </td>
        </tr>
    </table>

    <table class="footer-table">
        <tr>
            <td><div class="info-card"><h4>Peak Power</h4><p class="main-value">{{ main_run.peak_power.hp }} HP <span class="details">@ {{ main_run.peak_power.rpm }} RPM</span></p>{% if comparison_run %}<p class="comp-value">({{ comparison_run.peak_power.hp }} HP)</p>{% endif %}</div></td>
            <td><div class="info-card"><h4>Peak Torque</h4><p class="main-value">{{ main_run.peak_torque.torque }} N·m <span class="details">@ {{ main_run.peak_torque.rpm }} RPM</span></p>{% if comparison_run %}<p class="comp-value">({{ comparison_run.peak_torque.torque }} N·m)</p>{% endif %}</div></td>
            <td><div class="info-card"><h4>Data Points</h4><p class="main-value">{{ main_run.data_points_count }}</p>{% if comparison_run %}<p class="comp-value">({{ comparison_run.data_points_count }} Points)</p>{% endif %}</div></td>
            <td><div class="info-card"><h4>Test Config (Main)</h4><dl style="font-size: 7pt; margin:0 auto; display: grid; grid-template-columns: auto auto; gap: 0 8px; text-align: left; width: fit-content;"><dt>Gear Ratio: {{ main_run.config.Gear_Ratio or 'N/A' }}</dd><dt>Roller Ø: {{ main_run.config.Roller_Diameter or 'N/A' }}</dd><dt>Roller Mass: {{ main_run.config.Roller_Mass or 'N/A' }}</dd><dt>Actual MOI: {{ main_run.config.Actual_MOI or 'N/A' }}</dd></dl></div></td>
        </tr>
    </table>

    <!-- ======================= PAGE 2: APPENDIX ======================= -->
    <div class="appendix">
        <h1>Appendix A: Full Test Data</h1>
        <h2>Main Run: {{ main_run.filename }}</h2>
        <table class="appendix-table">
            <thead><tr><th>RPM</th><th>Torque (N·m)</th><th>Power (HP)</th></tr></thead>
            <tbody>
                {% for row in main_run.raw_data %}
                <tr><td>{{ row.rpm }}</td><td>{{ row.torque }}</td><td>{{ row.hp }}</td></tr>
                {% endfor %}
            </tbody>
        </table>
        {% if comparison_run %}
        <h2 style="margin-top: 25px;">Comparison Run: {{ comparison_run.filename }}</h2>
        <table class="appendix-table">
            <thead><tr><th>RPM</th><th>Torque (N·m)</th><th>Power (HP)</th></tr></thead>
            <tbody>
                {% for row in comparison_run.raw_data %}
                <tr><td>{{ row.rpm }}</td><td>{{ row.torque }}</td><td>{{ row.hp }}</td></tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>
</body>
</html>